<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ulawify – WAV to Teensy .h/.cpp</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: 40px auto;
      padding: 20px;
      text-align: center;
    }
    input[type="file"] {
      margin: 20px 0;
    }
    button {
      padding: 10px 20px;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <h1>ulawify</h1>
  <p>Convert a WAV file to Teensy-friendly µ-law <code>.h</code> and <code>.cpp</code> files</p>
  <input type="file" accept=".wav" id="fileInput"><br>
  <button onclick="processFile()">Convert & Download</button>
  <p id="status"></p>

  <script>
    function linearToUlaw(sample) {
      const BIAS = 0x84;
      const CLIP = 32635;

      let sign = (sample >> 8) & 0x80;
      if (sign) sample = -sample;
      if (sample > CLIP) sample = CLIP;
      sample += BIAS;

      let exponent = 7;
      for (let expMask = 0x4000; (sample & expMask) === 0 && exponent > 0; expMask >>= 1)
        exponent--;

      let mantissa = (sample >> (exponent + 3)) & 0x0F;
      return ~(sign | (exponent << 4) | mantissa) & 0xFF;
    }

    async function processFile() {
      const fileInput = document.getElementById('fileInput');
      const status = document.getElementById('status');
      if (!fileInput.files.length) return;

      const file = fileInput.files[0];
      const arrayBuffer = await file.arrayBuffer();
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const decoded = await audioCtx.decodeAudioData(arrayBuffer);

      status.textContent = 'Processing...';

      // Resample if needed
      let audioBuffer = decoded;
      if (decoded.sampleRate !== 44100) {
        const length = Math.floor(decoded.duration * 44100);
        const offlineCtx = new OfflineAudioContext(1, length, 44100);
        const source = offlineCtx.createBufferSource();
        source.buffer = decoded;
        source.connect(offlineCtx.destination);
        source.start();
        audioBuffer = await offlineCtx.startRendering();
      }

      // Mono downmix
      const len = audioBuffer.length;
      const mono = new Float32Array(len);
      if (audioBuffer.numberOfChannels === 1) {
        mono.set(audioBuffer.getChannelData(0));
      } else {
        const L = audioBuffer.getChannelData(0);
        const R = audioBuffer.getChannelData(1);
        for (let i = 0; i < len; i++) mono[i] = (L[i] + R[i]) * 0.5;
      }

      // µ-law encode
      const ulawBytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        const s = Math.max(-1, Math.min(1, mono[i]));
        const pcm16 = Math.floor(s * 32767);
        ulawBytes[i] = linearToUlaw(pcm16);
      }

      // Pack into unsigned int (4 bytes each)
      const packed = [];
      for (let i = 0; i < ulawBytes.length; i += 4) {
        let val = 0;
        for (let j = 0; j < 4; j++) {
          val |= (ulawBytes[i + j] || 0) << (8 * (3 - j));
        }
        packed.push(val >>> 0); // force unsigned
      }

      // Name sanitization
      const baseName = file.name.replace(/\.[^/.]+$/, '').replace(/[^a-zA-Z0-9]/g, '');
      const arrayName = 'AudioSample' + baseName.charAt(0).toUpperCase() + baseName.slice(1);

      // Generate header
      const header = `// Audio data converted from WAV file by ulawify\n` +
        `extern const unsigned int ${arrayName}[${packed.length}];\n`;

      // Generate cpp
      let cpp = `// Audio data converted from WAV file by ulawify\n`;
      cpp += `#include "${arrayName}.h"\n#include <Arduino.h>\n`;
      cpp += `// Converted from ${file.name}, using 44100 Hz, u-law encoding\nPROGMEM\n`;
      cpp += `const unsigned int ${arrayName}[${packed.length}] = {\n`;

      for (let i = 0; i < packed.length; i++) {
        if (i % 8 === 0) cpp += '  ';
        cpp += `0x${packed[i].toString(16).padStart(8, '0')}, `;
        if ((i + 1) % 8 === 0) cpp += '\n';
      }
      cpp += '};\n';

      // Zip up files
      const zip = new JSZip();
      zip.file(`${arrayName}.h`, header);
      zip.file(`${arrayName}.cpp`, cpp);
      const blob = await zip.generateAsync({ type: 'blob' });

      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${arrayName}_ulaw.zip`;
      a.click();

      status.textContent = 'Done!';
    }

    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js';
    document.head.appendChild(script);
  </script>
</body>
</html>
